<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Quiz | Paighaam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen flex items-center justify-center p-4">
  <div class="max-w-xl w-full bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 space-y-4">

    <div id="quiz-header" class="flex items-center justify-center space-x-2">
      <img id="quiz-logo" src="" alt="Logo" class="w-12 h-12 hidden" />
      <h1 id="quiz-title" class="text-2xl font-bold text-center">Daily Suwaal</h1>
    </div>

    <div id="quiz-box" class="space-y-3 hidden">
      <p id="question" class="font-semibold"></p>
      <div id="options-box" class="space-y-2 hidden"></div>
      <input type="text" id="text-answer" placeholder="Type your answer" class="hidden w-full border px-3 py-2 rounded"/>
      <input type="text" id="name" placeholder="Your Name" class="w-full border px-3 py-2 rounded" required>
      <input type="text" id="phone" placeholder="Phone Number" class="w-full border px-3 py-2 rounded" required>
      <input type="text" id="address" placeholder="Address" class="w-full border px-3 py-2 rounded" required>
      <button id="submit-btn" class="bg-blue-600 text-white w-full py-2 rounded">📤 Submit Answer</button>
    </div>

    <p id="status" class="text-center text-sm mt-2 text-red-500"></p>
    <p id="loading">⏳ Loading today's suwaal...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCSv-3o20aF6vASK_8FhZnC7xWjQMkr28U",
      authDomain: "paigam-ba913.firebaseapp.com",
      projectId: "paigam-ba913",
      storageBucket: "paigam-ba913.appspot.com",
      messagingSenderId: "480474970116",
      appId: "1:480474970116:web:4bbee23fe8234f66b1dd51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const quizBox = document.getElementById("quiz-box");
    const loading = document.getElementById("loading");
    const questionEl = document.getElementById("question");
    const optionsBox = document.getElementById("options-box");
    const textAnswer = document.getElementById("text-answer");
    const submitBtn = document.getElementById("submit-btn");
    const statusEl = document.getElementById("status");
    const quizTitle = document.getElementById("quiz-title");
    const quizLogo = document.getElementById("quiz-logo");

    let currentQuizId = "";
    let correctAnswer = "";
    let quizMode = "";
    let quizOptions = [];

    async function loadQuiz() {
      try {
        const now = new Date();
        const snapshot = await getDocs(collection(db, "dailyQuiz"));
        console.log("✅ Documents loaded:", snapshot.size);

        let activeQuiz = null;

        snapshot.forEach(doc => {
          const data = doc.data();
          try {
            const start = data.startTime.toDate();
            const end = data.endTime.toDate();
            console.log("🕒 Checking quiz:", data.title || data.question, start, end);

            if (start <= now && now <= end) {
              if (!activeQuiz || start > activeQuiz.data().startTime.toDate()) {
                activeQuiz = doc;
              }
            }
          } catch (e) {
            console.warn("⚠️ Error converting timestamps in doc:", doc.id, e);
          }
        });

        if (!activeQuiz) {
          loading.innerText = "⚠️ Aaj ke liye koi suwaal active nahi hai.";
          return;
        }

        const quiz = activeQuiz.data();
        currentQuizId = activeQuiz.id;
        correctAnswer = quiz.correct;
        quizMode = quiz.mode;
        quizOptions = quiz.options || [];

        quizTitle.innerText = quiz.title || "Daily Suwaal";
        if (quiz.imageURL) {
          quizLogo.src = quiz.imageURL;
          quizLogo.classList.remove("hidden");
        }

        loading.style.display = "none";
        quizBox.classList.remove("hidden");
        questionEl.innerText = "🧾 " + quiz.question;

        if (quizMode === "mcq") {
          optionsBox.classList.remove("hidden");
          optionsBox.innerHTML = "";
          quizOptions.forEach((opt, i) => {
            optionsBox.innerHTML += `
              <label class="block">
                <input type="radio" name="option" value="${i}" class="mr-2"> ${opt}
              </label>`;
          });
        } else {
          textAnswer.classList.remove("hidden");
        }

      } catch (err) {
        console.error("❌ Error loading quiz:", err);
        loading.innerText = "❌ Quiz load nahi ho paya. Thodi der baad koshish karein.";
      }
    }

    loadQuiz();

    submitBtn.onclick = async () => {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();

      if (!name || !phone || !address) {
        alert("⚠️ Please fill all fields.");
        return;
      }

      try {
        const check = query(
          collection(db, "quizAnswers"),
          where("questionId", "==", currentQuizId),
          where("phone", "==", phone)
        );
        const existing = await getDocs(check);
        if (!existing.empty) {
          statusEl.innerText = "🚫 Aap ne is suwaal ka already jawab diya hai.";
          return;
        }

        let userAnswer = "";
        if (quizMode === "mcq") {
          const selected = document.querySelector('input[name="option"]:checked');
          if (!selected) {
            alert("⚠️ Please select an option.");
            return;
          }
          userAnswer = selected.value;
        } else {
          userAnswer = textAnswer.value.trim().toLowerCase();
          if (!userAnswer) {
            alert("⚠️ Answer likhna zaroori hai.");
            return;
          }
        }

        let isCorrect = false;
        if (quizMode === "mcq") {
          isCorrect = userAnswer === correctAnswer;
        } else {
          const normalize = txt => txt.replace(/[^a-z0-9]/gi, '').toLowerCase();
          isCorrect = normalize(userAnswer).includes(normalize(correctAnswer));
        }

        await addDoc(collection(db, "quizAnswers"), {
          name, phone, address,
          answer: userAnswer,
          options: quizOptions,
          questionId: currentQuizId,
          correct: isCorrect,
          timestamp: Date.now()
        });

        statusEl.innerText = "✅ Aap ka jawab record ho gaya hai chahe sahi ho ya galat. In shaa Allah baad me bata denge.";
        submitBtn.disabled = true;
        submitBtn.innerText = "✅ Submitted";
        textAnswer.disabled = true;
        document.getElementById("name").disabled = true;
        document.getElementById("phone").disabled = true;
        document.getElementById("address").disabled = true;
        const radios = document.querySelectorAll('input[name="option"]');
        radios.forEach(r => r.disabled = true);

      } catch (err) {
        console.error("❌ Error submitting answer:", err);
        statusEl.innerText = "❌ Kuch ghalti ho gayi. Dubara koshish karein.";
      }
    };
  </script>
</body>
</html>
