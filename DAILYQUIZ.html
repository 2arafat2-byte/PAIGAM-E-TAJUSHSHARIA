<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title id="page-title">Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-white min-h-screen flex items-center justify-center p-4">
  <div class="max-w-xl w-full bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 space-y-4">
    <h1 id="quiz-title" class="text-2xl font-bold text-center">Loading...</h1>

    <div id="quiz-box" class="space-y-3 hidden">
      <p id="question" class="font-semibold"></p>

      <!-- MCQ Options -->
      <div id="options-box" class="space-y-2 hidden"></div>

      <!-- Text Answer -->
      <input type="text" id="text-answer" placeholder="Type your answer" class="hidden w-full border px-3 py-2 rounded"/>

      <input type="text" id="name" placeholder="Your Name" class="w-full border px-3 py-2 rounded" required>
      <input type="text" id="phone" placeholder="Phone Number" class="w-full border px-3 py-2 rounded" required>
      <input type="text" id="address" placeholder="Address" class="w-full border px-3 py-2 rounded" required>

      <button id="submit-btn" class="bg-blue-600 text-white w-full py-2 rounded">üì§ Submit Answer</button>
      <p id="status" class="text-center text-sm"></p>
    </div>

    <p id="loading">‚è≥ Loading today‚Äôs quiz...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCSv-3o20aF6vASK_8FhZnC7xWjQMkr28U",
      authDomain: "paigam-ba913.firebaseapp.com",
      projectId: "paigam-ba913",
      storageBucket: "paigam-ba913.appspot.com",
      messagingSenderId: "480474970116",
      appId: "1:480474970116:web:4bbee23fe8234f66b1dd51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const quizBox = document.getElementById("quiz-box");
    const loading = document.getElementById("loading");
    const questionEl = document.getElementById("question");
    const optionsBox = document.getElementById("options-box");
    const textAnswer = document.getElementById("text-answer");
    const submitBtn = document.getElementById("submit-btn");
    const statusEl = document.getElementById("status");

    const quizTitle = document.getElementById("quiz-title");
    const pageTitle = document.getElementById("page-title");

    let currentQuizId = "";
    let correctAnswer = "";
    let quizMode = "";
    let quizOptions = [];

    async function loadQuiz() {
      const now = new Date().toISOString();
      const q = query(collection(db, "dailyQuiz"), where("date", "<=", now));
      const snapshot = await getDocs(q);

      let latestQuiz = null;
      snapshot.forEach(doc => {
        if (!latestQuiz || doc.data().date > latestQuiz.data().date) {
          latestQuiz = doc;
        }
      });

      if (!latestQuiz) {
        loading.innerText = "‚ö†Ô∏è No quiz set yet.";
        return;
      }

      const quiz = latestQuiz.data();
      currentQuizId = latestQuiz.id;
      correctAnswer = quiz.correct;
      quizMode = quiz.mode;
      quizOptions = quiz.options || [];

      const title = quiz.title || "Quiz";
      quizTitle.innerText = "üìò " + title;
      pageTitle.innerText = title;

      loading.style.display = "none";
      quizBox.classList.remove("hidden");
      questionEl.innerText = "üßæ " + quiz.question;

      if (quizMode === "mcq") {
        optionsBox.classList.remove("hidden");
        optionsBox.innerHTML = "";
        quizOptions.forEach((opt, i) => {
          optionsBox.innerHTML += `
            <label class="block">
              <input type="radio" name="option" value="${i}" class="mr-2"> ${opt}
            </label>`;
        });
      } else {
        textAnswer.classList.remove("hidden");
      }
    }

    loadQuiz();

    submitBtn.onclick = async () => {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();

      if (!name || !phone || !address) return alert("‚ö†Ô∏è Please fill all fields.");

      // Check for duplicate submission
      const check = query(
        collection(db, "quizAnswers"),
        where("questionId", "==", currentQuizId),
        where("phone", "==", phone)
      );
      const existing = await getDocs(check);
      if (!existing.empty) {
        statusEl.innerText = "üö´ Aap is suwaal ka already jawab de chuke hain.";
        return;
      }

      let userAnswer = "";
      if (quizMode === "mcq") {
        const selected = document.querySelector('input[name="option"]:checked');
        if (!selected) return alert("‚ö†Ô∏è Please select an option.");
        userAnswer = selected.value;
      } else {
        userAnswer = textAnswer.value.trim().toLowerCase();
        if (!userAnswer) return alert("‚ö†Ô∏è Answer likhna zaroori hai.");
      }

      let isCorrect = false;
      if (quizMode === "mcq") {
        isCorrect = userAnswer === correctAnswer;
      } else {
        const normalize = (txt) => txt.replace(/[^a-z0-9]/gi, '').toLowerCase();
        isCorrect = normalize(userAnswer).includes(normalize(correctAnswer));
      }

      await addDoc(collection(db, "quizAnswers"), {
        name, phone, address,
        answer: userAnswer,
        options: quizOptions,
        questionId: currentQuizId,
        correct: isCorrect,
        timestamp: Date.now()
      });

      statusEl.innerText = "‚úÖ Aap ka jawaab record ho gaya hai chahe sahi ho ya galat. In shaa Allah baad me bata denge.";
      quizBox.innerHTML = "";
    };
  </script>
</body>
</html>
